# FAISSæ•°æ®åº“æŸ¥çœ‹å·¥å…·ä½¿ç”¨è¯´æ˜

æœ¬ç›®å½•åŒ…å«äº†ä¸‰ä¸ªç”¨äºæŸ¥çœ‹å’Œåˆ†æFAISSæ•°æ®åº“çš„Pythonè„šæœ¬ï¼Œå¯ä»¥å¸®åŠ©æ‚¨æŸ¥çœ‹`index.faiss`å’Œ`index.pkl`æ–‡ä»¶ä¸­çš„æ‚£è€…æ•°æ®ã€‚

## å·¥å…·æ¦‚è§ˆ

### 1. `faiss_data_viewer.py` - å®Œæ•´åŠŸèƒ½æŸ¥çœ‹å™¨
**åŠŸèƒ½æœ€å…¨é¢çš„å·¥å…·ï¼Œæ”¯æŒäº¤äº’å¼æ“ä½œ**

**ä¸»è¦åŠŸèƒ½ï¼š**
- æ£€æŸ¥FAISSæ–‡ä»¶çŠ¶æ€
- åˆ†ææ‚£è€…æ•°æ®ç»Ÿè®¡
- äº¤äº’å¼æŸ¥çœ‹æ‚£è€…è¯¦ç»†ä¿¡æ¯
- å‘é‡æ•°æ®åˆ†æ
- æ•°æ®å¯¼å‡ºåŠŸèƒ½

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
# äº¤äº’æ¨¡å¼ï¼ˆæ¨èï¼‰
python scripts/faiss_data_viewer.py

# æŸ¥çœ‹ç‰¹å®šæ‚£è€…
python scripts/faiss_data_viewer.py --patient-id 11489167

# å¯¼å‡ºæ•°æ®
python scripts/faiss_data_viewer.py --export exported_data

# éäº¤äº’æ¨¡å¼
python scripts/faiss_data_viewer.py --no-interactive

# æŒ‡å®šæ•°æ®åº“è·¯å¾„
python scripts/faiss_data_viewer.py --db-path /path/to/clinical_memory_db
```

### 2. `quick_faiss_viewer.py` - å¿«é€ŸæŸ¥çœ‹å™¨
**è½»é‡çº§å·¥å…·ï¼Œé€‚åˆå¿«é€ŸæŸ¥çœ‹æ•°æ®**

**ä¸»è¦åŠŸèƒ½ï¼š**
- å¿«é€Ÿæ£€æŸ¥æ–‡ä»¶çŠ¶æ€
- æ˜¾ç¤ºæ‚£è€…åˆ—è¡¨
- æŸ¥çœ‹æ‚£è€…åŸºæœ¬ä¿¡æ¯
- ç®€åŒ–çš„äº¤äº’ç•Œé¢

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
python scripts/quick_faiss_viewer.py
```

### 3. `export_faiss_data.py` - æ•°æ®å¯¼å‡ºå·¥å…·
**ä¸“é—¨ç”¨äºæ•°æ®å¯¼å‡ºå’Œæ ¼å¼è½¬æ¢**

**ä¸»è¦åŠŸèƒ½ï¼š**
- å¯¼å‡ºä¸ºJSONæ ¼å¼
- å¯¼å‡ºä¸ºCSVæ ¼å¼
- ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
- æ”¯æŒå¤šç§å¯¼å‡ºé€‰é¡¹

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
# å¯¼å‡ºæ‰€æœ‰æ ¼å¼
python scripts/export_faiss_data.py

# åªå¯¼å‡ºJSON
python scripts/export_faiss_data.py --format json

# åªå¯¼å‡ºCSV
python scripts/export_faiss_data.py --format csv

# æŒ‡å®šè¾“å‡ºç›®å½•
python scripts/export_faiss_data.py --output my_export_dir

# ä¸ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
python scripts/export_faiss_data.py --no-report
```

## æ•°æ®ç»“æ„è¯´æ˜

### æ‚£è€…æ•°æ®åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

- **åŸºæœ¬ä¿¡æ¯**
  - `subject_id`: æ‚£è€…ID
  - `gender`: æ€§åˆ«
  - `anchor_age`: å¹´é¾„

- **åŒ»ç–—å†å²**
  - `allergies`: è¿‡æ•å²åˆ—è¡¨
  - `cancer_history`: ç™Œç—‡ç—…å²
  - `chronic_diseases`: æ…¢æ€§ç–¾ç—…åˆ—è¡¨

- **æ£€éªŒæ•°æ®**
  - `baseline_labs`: åŸºçº¿æ£€éªŒç»“æœ
  - `baseline_vitals`: åŸºçº¿ç”Ÿå‘½ä½“å¾

- **è¯ç‰©ä¿¡æ¯**
  - `discharge_medications`: å‡ºé™¢è¯ç‰©åˆ—è¡¨

- **ç—…æƒ…æ€»ç»“**
  - `daily_summaries`: åŒ…å«ç—…æƒ…è¶‹åŠ¿å’Œæ€»ç»“

## è¾“å‡ºæ–‡ä»¶è¯´æ˜

### JSONå¯¼å‡ºæ–‡ä»¶ï¼š
- `all_patients_full.json`: æ‰€æœ‰æ‚£è€…å®Œæ•´æ•°æ®
- `individual_patients/patient_*.json`: æ¯ä¸ªæ‚£è€…çš„å•ç‹¬æ–‡ä»¶
- `summary_report.json`: æ•°æ®åº“æ±‡æ€»æŠ¥å‘Š

### CSVå¯¼å‡ºæ–‡ä»¶ï¼š
- `patients_basic_info.csv`: æ‚£è€…åŸºæœ¬ä¿¡æ¯
- `chronic_diseases.csv`: æ…¢æ€§ç–¾ç—…è¯¦æƒ…
- `baseline_labs.csv`: åŸºçº¿æ£€éªŒæ•°æ®
- `medications.csv`: è¯ç‰©ä¿¡æ¯

### æŠ¥å‘Šæ–‡ä»¶ï¼š
- `summary_report.txt`: æ–‡æœ¬æ ¼å¼æ±‡æ€»æŠ¥å‘Š
- `summary_report.json`: JSONæ ¼å¼æ±‡æ€»æŠ¥å‘Š

## ä½¿ç”¨å»ºè®®

### é¦–æ¬¡ä½¿ç”¨ï¼š
1. å…ˆè¿è¡Œ `quick_faiss_viewer.py` å¿«é€Ÿäº†è§£æ•°æ®æ¦‚å†µ
2. ä½¿ç”¨ `faiss_data_viewer.py` è¿›è¡Œè¯¦ç»†åˆ†æ
3. æ ¹æ®éœ€è¦ä½¿ç”¨ `export_faiss_data.py` å¯¼å‡ºæ•°æ®

### å¸¸è§ç”¨é€”ï¼š

**æŸ¥çœ‹æ•°æ®æ¦‚å†µï¼š**
```bash
python scripts/quick_faiss_viewer.py
```

**è¯¦ç»†åˆ†æç‰¹å®šæ‚£è€…ï¼š**
```bash
python scripts/faiss_data_viewer.py --patient-id YOUR_PATIENT_ID
```

**å¯¼å‡ºæ•°æ®è¿›è¡Œè¿›ä¸€æ­¥åˆ†æï¼š**
```bash
python scripts/export_faiss_data.py --output analysis_data
```

**äº¤äº’å¼æ¢ç´¢ï¼š**
```bash
python scripts/faiss_data_viewer.py
```

## ä¾èµ–è¦æ±‚

### å¿…éœ€ä¾èµ–ï¼š
- `pickle` (Pythonæ ‡å‡†åº“)
- `json` (Pythonæ ‡å‡†åº“)
- `pathlib` (Pythonæ ‡å‡†åº“)

### å¯é€‰ä¾èµ–ï¼š
- `faiss`: ç”¨äºFAISSç´¢å¼•åˆ†æ
- `pandas`: ç”¨äºCSVå¯¼å‡º
- `numpy`: ç”¨äºæ•°å€¼è®¡ç®—

### å®‰è£…å¯é€‰ä¾èµ–ï¼š
```bash
pip install faiss-cpu pandas numpy
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜ï¼š

1. **æ–‡ä»¶ä¸å­˜åœ¨é”™è¯¯**
   - ç¡®ä¿ `clinical_memory_db/index.pkl` æ–‡ä»¶å­˜åœ¨
   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®

2. **JSONè§£æé”™è¯¯**
   - æ•°æ®æ–‡ä»¶å¯èƒ½æŸåï¼Œå°è¯•é‡æ–°ç”Ÿæˆ

3. **FAISSåº“æœªå®‰è£…**
   - è¿è¡Œ `pip install faiss-cpu` å®‰è£…FAISSåº“
   - æˆ–è€…å¿½ç•¥FAISSç›¸å…³åŠŸèƒ½ï¼Œåªä½¿ç”¨PKLæ•°æ®

4. **å†…å­˜ä¸è¶³**
   - å¯¹äºå¤§å‹æ•°æ®åº“ï¼Œå»ºè®®ä½¿ç”¨å¯¼å‡ºå·¥å…·åˆ†æ‰¹å¤„ç†

### è·å–å¸®åŠ©ï¼š
```bash
python scripts/faiss_data_viewer.py --help
python scripts/export_faiss_data.py --help
```

## ç¤ºä¾‹è¾“å‡º

### æ‚£è€…åˆ—è¡¨ç¤ºä¾‹ï¼š
```
åºå· æ‚£è€…ID       æ€§åˆ«   å¹´é¾„   æ…¢æ€§ç–¾ç—…  æ£€éªŒé¡¹ç›®  ç—…æƒ…è¶‹åŠ¿
------------------------------------------------------------
1    11489167    M      65     3        15       improving
2    11489168    F      72     5        12       stable
3    11489169    M      58     2        18       worsening
```

### æ±‡æ€»æŠ¥å‘Šç¤ºä¾‹ï¼š
```
FAISSæ•°æ®åº“æ±‡æ€»æŠ¥å‘Š
==================
å¯¼å‡ºæ—¶é—´: 2024-01-15 10:30:00

æ‚£è€…ç»Ÿè®¡:
- æ€»æ‚£è€…æ•°: 150
- æ€§åˆ«åˆ†å¸ƒ: {'M': 85, 'F': 65}
- å¹´é¾„èŒƒå›´: 18 - 95 å² (å¹³å‡: 64.2)

åŒ»ç–—æ•°æ®ç»Ÿè®¡:
- æ…¢æ€§ç–¾ç—…æ€»æ•°: 450 (å¹³å‡æ¯äºº: 3.0)
- åŸºçº¿æ£€éªŒæ€»æ•°: 2250 (å¹³å‡æ¯äºº: 15.0)
- å‡ºé™¢è¯ç‰©æ€»æ•°: 750 (å¹³å‡æ¯äºº: 5.0)
```

### æ•°æ®è®°å½•
```shell
ğŸ‘¥ æ‚£è€…åˆ—è¡¨:
--------------------------------------------------------------------------------
åºå·   æ‚£è€…ID         æ€§åˆ«     å¹´é¾„     æ…¢æ€§ç–¾ç—…     æ£€éªŒ     è¯ç‰©     è¶‹åŠ¿        
--------------------------------------------------------------------------------
1    14840724     F      42     1        0      20     stable    
2    19747913     F      82     5        0      13     stable    
3    17749823     F      61     0        24     26     worsen    
4    19913456     F      54     0        41     87     worsen    
5    16082161     F      38     0        5      24     improve   
6    11489167     F      55     5        12     11     stable    
7    13166211     F      39     2        0      17     stable    
8    19737081     F      50     2        37     57     improve   
9    18206867     F      46     0        22     27     worsen    
10   18194799     F      40     0        0      8      stable    

============================================================
ğŸ“‹ æ‚£è€…è¯¦ç»†ä¿¡æ¯ç¤ºä¾‹ (æ‚£è€…ID: 14840724)
============================================================
ğŸ‘¤ åŸºæœ¬ä¿¡æ¯:
  æ‚£è€…ID: 14840724
  æ€§åˆ«: F
  å¹´é¾„: 42

ğŸš« è¿‡æ•å² (1 é¡¹):
  - 

ğŸ—ï¸ ç™Œç—‡ç—…å² (2 é¡¹):
  - Secondary and unspecified malignant neoplasm of lymph nodes of axilla and upper limb (ICD9: 1963)
  - Malignant neoplasm of breast (female), unspecified (ICD9: 1749)

ğŸ¥ æ…¢æ€§ç–¾ç—… (1 é¡¹):
  - Tobacco use disorder (ICD9: 3051)

ğŸ’“ åŸºçº¿ç”Ÿå‘½ä½“å¾:
  - temp: 98.7
  - heart_rate: 56
  - sbp: 90
  - dbp: 60
  - resp_rate: 18
  - spo2: 99

ğŸ’Š å‡ºé™¢è¯ç‰© (20 é¡¹):
  - OxycoDONE (Immediate Release)  (10-20, PO/NG)
  - TraMADOL (Ultram) (100, PO)
  - Lorazepam (0.5-1, PO/NG)
  - Acetaminophen (1000, PO/NG)
  - Diazepam (5, PO/NG)
  ... è¿˜æœ‰ 15 é¡¹

ğŸ“Š ç—…æƒ…æ€»ç»“:
  è¶‹åŠ¿: stable
  æ€»ç»“: ç»“æ„åŒ–è®°å½•è¾ƒå°‘ï¼Œä¾æ®å‡ºé™¢ç”Ÿå‘½ä½“å¾ï¼šä½“æ¸©98.7ï¼Œå¿ƒç‡56ï¼Œè¡€å‹90/60ï¼Œå‘¼å¸18ï¼Œè¡€æ°§99%ã€‚æ•´ä½“è¶‹äºç¨³å®šã€‚

============================================================
ğŸ“‹ æœ‰æ…¢æ€§ç–¾ç—…çš„æ‚£è€…ç¤ºä¾‹ (æ‚£è€…ID: 14840724)
============================================================
ğŸ‘¤ åŸºæœ¬ä¿¡æ¯:
  æ‚£è€…ID: 14840724
  æ€§åˆ«: F
  å¹´é¾„: 42

ğŸš« è¿‡æ•å² (1 é¡¹):
  - 

ğŸ—ï¸ ç™Œç—‡ç—…å² (2 é¡¹):
  - Secondary and unspecified malignant neoplasm of lymph nodes of axilla and upper limb (ICD9: 1963)
  - Malignant neoplasm of breast (female), unspecified (ICD9: 1749)

ğŸ¥ æ…¢æ€§ç–¾ç—… (1 é¡¹):
  - Tobacco use disorder (ICD9: 3051)

ğŸ’“ åŸºçº¿ç”Ÿå‘½ä½“å¾:
  - temp: 98.7
  - heart_rate: 56
  - sbp: 90
  - dbp: 60
  - resp_rate: 18
  - spo2: 99

ğŸ’Š å‡ºé™¢è¯ç‰© (20 é¡¹):
  - OxycoDONE (Immediate Release)  (10-20, PO/NG)
  - TraMADOL (Ultram) (100, PO)
  - Lorazepam (0.5-1, PO/NG)
  - Acetaminophen (1000, PO/NG)
  - Diazepam (5, PO/NG)
  ... è¿˜æœ‰ 15 é¡¹

ğŸ“Š ç—…æƒ…æ€»ç»“:
  è¶‹åŠ¿: stable
  æ€»ç»“: ç»“æ„åŒ–è®°å½•è¾ƒå°‘ï¼Œä¾æ®å‡ºé™¢ç”Ÿå‘½ä½“å¾ï¼šä½“æ¸©98.7ï¼Œå¿ƒç‡56ï¼Œè¡€å‹90/60ï¼Œå‘¼å¸18ï¼Œè¡€æ°§99%ã€‚æ•´ä½“è¶‹äºç¨³å®šã€‚
```

### æ‰€æœ‰æ•°æ®
```shell
ğŸ¥ FAISSæ•°æ®åº“æ‚£è€…æ•°æ®æ¼”ç¤º
============================================================
âœ… æˆåŠŸåŠ è½½æ•°æ®
ğŸ“„ æ–‡æ¡£æ•°é‡: 10
ğŸ”— ç´¢å¼•æ˜ å°„: 10
âœ… è§£æå‡º 10 ä½æ‚£è€…æ•°æ®

ğŸ“Š æ•°æ®åº“ç»Ÿè®¡:
  æ€§åˆ«åˆ†å¸ƒ: {'F': 10}
  å¹´é¾„èŒƒå›´: 38 - 82 å² (å¹³å‡: 50.7)
  æ…¢æ€§ç–¾ç—…æ€»æ•°: 15
  åŸºçº¿æ£€éªŒæ€»æ•°: 141
  å‡ºé™¢è¯ç‰©æ€»æ•°: 290

ğŸ‘¥ æ‚£è€…åˆ—è¡¨:
--------------------------------------------------------------------------------
åºå·   æ‚£è€…ID         æ€§åˆ«     å¹´é¾„     æ…¢æ€§ç–¾ç—…     æ£€éªŒ     è¯ç‰©     è¶‹åŠ¿        
--------------------------------------------------------------------------------
1    14840724     F      42     1        0      20     stable    
2    19747913     F      82     5        0      13     stable    
3    17749823     F      61     0        24     26     worsen    
4    19913456     F      54     0        41     87     worsen    
5    16082161     F      38     0        5      24     improve   
6    11489167     F      55     5        12     11     stable    
7    13166211     F      39     2        0      17     stable    
8    19737081     F      50     2        37     57     improve   
9    18206867     F      46     0        22     27     worsen    
10   18194799     F      40     0        0      8      stable    
```