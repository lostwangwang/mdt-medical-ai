#!/usr/bin/env python3
"""
ç®€åŒ–ç‰ˆMDTå…±è¯†æ¼”ç¤º
å±•ç¤ºä»æ‚£è€…æ•°æ®åˆ°å…±è¯†è¾¾æˆçš„å…³é”®æ­¥éª¤
"""

import sys
import os
from pathlib import Path
from datetime import datetime
import json

# æ·»åŠ é¡¹ç›®è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from src.utils.llm_interface import LLMConfig, LLMInterface
from src.knowledge.enhanced_faiss_integration import EnhancedFAISSManager
from src.knowledge.rag_system import MedicalKnowledgeRAG
from src.consensus.dialogue_manager import MultiAgentDialogueManager

def demonstrate_consensus_flow():
    """æ¼”ç¤ºå…±è¯†è¾¾æˆæµç¨‹"""
    
    print("ğŸ¥ MDTåŒ»ç–—AIç³»ç»Ÿ - å…±è¯†è¾¾æˆæµç¨‹æ¼”ç¤º")
    print("=" * 60)
    
    # æ­¥éª¤1: æ‚£è€…æ•°æ®è¾“å…¥
    print("\nğŸ“‹ æ­¥éª¤1: æ‚£è€…æ•°æ®è¾“å…¥")
    print("-" * 30)
    patient_data = {
        "patient_id": "DEMO_001",
        "age": 58,
        "diagnosis": "ä¹³è…ºç™Œ",
        "stage": "IIIAæœŸ",
        "symptoms": ["ä¹³æˆ¿è‚¿å—", "ç–²åŠ³", "è½»å¾®ç–¼ç—›"],
        "comorbidities": ["é«˜è¡€å‹", "2å‹ç³–å°¿ç—…"],
        "lab_results": {
            "è¡€çº¢è›‹ç™½": "11.2 g/dL",
            "ç™½ç»†èƒ": "6800/Î¼L", 
            "è¡€å°æ¿": "280,000/Î¼L",
            "è‚Œé…": "0.9 mg/dL"
        }
    }
    
    print(f"ğŸ‘¤ æ‚£è€…: {patient_data['patient_id']}")
    print(f"ğŸ“Š åŸºæœ¬ä¿¡æ¯: {patient_data['age']}å², {patient_data['diagnosis']}, {patient_data['stage']}")
    print(f"ğŸ”¬ ä¸»è¦ç—‡çŠ¶: {', '.join(patient_data['symptoms'])}")
    print(f"âš•ï¸  åˆå¹¶ç—‡: {', '.join(patient_data['comorbidities'])}")
    
    # æ­¥éª¤2: çŸ¥è¯†æ£€ç´¢ // è¿™é‡Œå¯ä»¥å…ˆä¸ç®¡
    print("\nğŸ” æ­¥éª¤2: åŒ»å­¦çŸ¥è¯†æ£€ç´¢")
    print("-" * 30)
    print("ğŸ“š æ£€ç´¢æŸ¥è¯¢: 'IIIAæœŸä¹³è…ºç™Œæ²»ç–—æ–¹æ¡ˆ'")
    print("ğŸ” æ£€ç´¢åˆ°ç›¸å…³çŸ¥è¯†:")
    print("   â€¢ NCCNä¹³è…ºç™Œæ²»ç–—æŒ‡å—")
    print("   â€¢ æ–°è¾…åŠ©åŒ–ç–—ä¸´åºŠç ”ç©¶")
    print("   â€¢ ä¿ä¹³æ‰‹æœ¯é€‚åº”ç—‡")
    print("   â€¢ æ”¾ç–—å‰‚é‡åˆ†å‰²æ–¹æ¡ˆ")
    print("âœ… çŸ¥è¯†æ£€ç´¢å®Œæˆ")
    
    # æ­¥éª¤3: æ™ºèƒ½ä½“åˆå§‹åŒ–
    print("\nğŸ‘¥ æ­¥éª¤3: MDTæ™ºèƒ½ä½“åˆå§‹åŒ–")
    print("-" * 30)
    agents = [
        "ğŸ©º è‚¿ç˜¤ç§‘åŒ»ç”Ÿ",
        "ğŸ”ª å¤–ç§‘åŒ»ç”Ÿ", 
        "ğŸ“¡ æ”¾å°„ç§‘åŒ»ç”Ÿ",
        "ğŸ”¬ ç—…ç†ç§‘åŒ»ç”Ÿ",
        "ğŸ‘© ä¸“ç§‘æŠ¤å£«"
    ]
    
    for agent in agents:
        print(f"âœ… {agent} åˆå§‹åŒ–å®Œæˆ")
    
    # æ­¥éª¤4: åˆå§‹æ„è§ç”Ÿæˆ
    print("\nğŸ’­ æ­¥éª¤4: ç”Ÿæˆåˆå§‹ä¸“ä¸šæ„è§")
    print("-" * 30)
    
    initial_opinions = {
        "è‚¿ç˜¤ç§‘åŒ»ç”Ÿ": {
            "åŒ–ç–—": {"è¯„åˆ†": 0.85, "æ¨ç†": "IIIAæœŸä¹³è…ºç™Œæ ‡å‡†æ²»ç–—ï¼Œæ–°è¾…åŠ©åŒ–ç–—å¯ç¼©å°è‚¿ç˜¤"},
            "æ‰‹æœ¯": {"è¯„åˆ†": 0.75, "æ¨ç†": "åŒ–ç–—åå¯è€ƒè™‘æ‰‹æœ¯ï¼Œéœ€è¯„ä¼°æ‰‹æœ¯é£é™©"},
            "æ”¾ç–—": {"è¯„åˆ†": 0.70, "æ¨ç†": "æœ¯åè¾…åŠ©æ”¾ç–—ï¼Œé™ä½å±€éƒ¨å¤å‘é£é™©"}
        },
        "å¤–ç§‘åŒ»ç”Ÿ": {
            "æ‰‹æœ¯": {"è¯„åˆ†": 0.80, "æ¨ç†": "æ ¹æ²»æ€§æ‰‹æœ¯æ˜¯å…³é”®ï¼Œä½†éœ€è€ƒè™‘æ‚£è€…åˆå¹¶ç—‡"},
            "åŒ–ç–—": {"è¯„åˆ†": 0.75, "æ¨ç†": "æ–°è¾…åŠ©åŒ–ç–—æœ‰åŠ©äºæ‰‹æœ¯åˆ‡é™¤"},
            "æ”¾ç–—": {"è¯„åˆ†": 0.65, "æ¨ç†": "æœ¯åæ”¾ç–—ä½œä¸ºè¾…åŠ©æ²»ç–—"}
        },
        "æ”¾å°„ç§‘åŒ»ç”Ÿ": {
            "æ”¾ç–—": {"è¯„åˆ†": 0.78, "æ¨ç†": "ç²¾ç¡®æ”¾ç–—æŠ€æœ¯å¯æœ‰æ•ˆæ§åˆ¶å±€éƒ¨ç—…ç¶"},
            "åŒ–ç–—": {"è¯„åˆ†": 0.70, "æ¨ç†": "åŒ–ç–—è”åˆæ”¾ç–—æœ‰ååŒæ•ˆåº”"},
            "æ‰‹æœ¯": {"è¯„åˆ†": 0.68, "æ¨ç†": "å½±åƒè¯„ä¼°æ˜¾ç¤ºæ‰‹æœ¯å¯è¡Œæ€§"}
        }
    }
    
    for doctor, opinions in initial_opinions.items():
        print(f"\nğŸ”¬ {doctor} çš„åˆå§‹æ„è§:")
        for treatment, data in opinions.items():
            print(f"   {treatment}: {data['è¯„åˆ†']:.2f} - {data['æ¨ç†']}")
    
    # æ­¥éª¤5: å¤šè½®å¯¹è¯åå•†
    print("\nğŸ’¬ æ­¥éª¤5: å¤šè½®å¯¹è¯åå•†")
    print("-" * 30)
    
    dialogue_rounds = [
        {
            "è½®æ¬¡": 1,
            "ä¸»é¢˜": "æ²»ç–—æ–¹æ¡ˆä¼˜å…ˆçº§è®¨è®º",
            "å‘è¨€": [
                "è‚¿ç˜¤ç§‘åŒ»ç”Ÿ: å»ºè®®å…ˆè¡Œæ–°è¾…åŠ©åŒ–ç–—ï¼Œè¯„ä¼°è‚¿ç˜¤ååº”åå†³å®šæ‰‹æœ¯æ–¹æ¡ˆ",
                "å¤–ç§‘åŒ»ç”Ÿ: åŒæ„åŒ–ç–—ä¼˜å…ˆï¼Œä½†éœ€å¯†åˆ‡ç›‘æµ‹æ‚£è€…è€å—æ€§",
                "æ”¾å°„ç§‘åŒ»ç”Ÿ: æ”¯æŒå¤šå­¦ç§‘ç»¼åˆæ²»ç–—ï¼Œæ”¾ç–—æ—¶æœºéœ€è¦åè°ƒ",
                "ç—…ç†ç§‘åŒ»ç”Ÿ: å»ºè®®è·å–æ›´å¤šåˆ†å­æ ‡å¿—ç‰©ä¿¡æ¯æŒ‡å¯¼æ²»ç–—",
                "ä¸“ç§‘æŠ¤å£«: å…³æ³¨æ‚£è€…å¿ƒç†çŠ¶æ€ï¼Œéœ€è¦å……åˆ†çš„æ‚£è€…æ•™è‚²"
            ],
            "æ”¶æ•›åº¦": 0.65
        },
        {
            "è½®æ¬¡": 2, 
            "ä¸»é¢˜": "æ²»ç–—æ—¶åºå’Œå‰‚é‡è°ƒæ•´",
            "å‘è¨€": [
                "è‚¿ç˜¤ç§‘åŒ»ç”Ÿ: è€ƒè™‘åˆ°ç³–å°¿ç—…ï¼ŒåŒ–ç–—å‰‚é‡éœ€è¦é€‚å½“è°ƒæ•´",
                "å¤–ç§‘åŒ»ç”Ÿ: åŒ–ç–—4-6å‘¨æœŸåè¯„ä¼°ï¼Œå¦‚æœååº”è‰¯å¥½å¯è¡Œä¿ä¹³æ‰‹æœ¯",
                "æ”¾å°„ç§‘åŒ»ç”Ÿ: æœ¯åæ”¾ç–—å‰‚é‡50Gy/25æ¬¡ï¼Œéœ€è¦å¿ƒè„ä¿æŠ¤",
                "ç—…ç†ç§‘åŒ»ç”Ÿ: åŒ–ç–—åç—…ç†å®Œå…¨ç¼“è§£ç‡çº¦30%ï¼Œéœ€è¦åŠ¨æ€è¯„ä¼°",
                "ä¸“ç§‘æŠ¤å£«: åˆ¶å®šä¸ªæ€§åŒ–æŠ¤ç†è®¡åˆ’ï¼Œé‡ç‚¹å…³æ³¨è¡€ç³–ç®¡ç†"
            ],
            "æ”¶æ•›åº¦": 0.78
        },
        {
            "è½®æ¬¡": 3,
            "ä¸»é¢˜": "æœ€ç»ˆæ–¹æ¡ˆç¡®è®¤",
            "å‘è¨€": [
                "è‚¿ç˜¤ç§‘åŒ»ç”Ÿ: æœ€ç»ˆæ–¹æ¡ˆï¼šæ–°è¾…åŠ©åŒ–ç–—â†’æ‰‹æœ¯â†’è¾…åŠ©æ”¾ç–—",
                "å¤–ç§‘åŒ»ç”Ÿ: åŒæ„è¯¥æ–¹æ¡ˆï¼Œæ‰‹æœ¯æ–¹å¼æ ¹æ®åŒ–ç–—ååº”å†³å®š",
                "æ”¾å°„ç§‘åŒ»ç”Ÿ: æ”¾ç–—è®¡åˆ’å·²åˆ¶å®šï¼Œä¸æ‰‹æœ¯æ—¶æœºåè°ƒ",
                "ç—…ç†ç§‘åŒ»ç”Ÿ: æ”¯æŒè¯¥ç»¼åˆæ²»ç–—æ–¹æ¡ˆ",
                "ä¸“ç§‘æŠ¤å£«: å…¨ç¨‹æŠ¤ç†æ–¹æ¡ˆå·²å‡†å¤‡å°±ç»ª"
            ],
            "æ”¶æ•›åº¦": 0.92
        }
    ]
    
    for round_data in dialogue_rounds:
        print(f"\nğŸ”„ ç¬¬ {round_data['è½®æ¬¡']} è½®å¯¹è¯ - {round_data['ä¸»é¢˜']}")
        for statement in round_data['å‘è¨€']:
            print(f"   ğŸ’¬ {statement}")
        print(f"   ğŸ“Š æ”¶æ•›åº¦: {round_data['æ”¶æ•›åº¦']:.2f}")
        
        if round_data['æ”¶æ•›åº¦'] > 0.9:
            print("   ğŸ‰ è¾¾æˆé«˜åº¦å…±è¯†ï¼")
    
    # æ­¥éª¤6: å…±è¯†è¯„ä¼°
    print("\nğŸ¯ æ­¥éª¤6: å…±è¯†è¯„ä¼°")
    print("-" * 30)
    
    final_scores = {
        "æ–°è¾…åŠ©åŒ–ç–—": 0.88,
        "æ‰‹æœ¯æ²»ç–—": 0.82, 
        "è¾…åŠ©æ”¾ç–—": 0.79
    }
    
    print("ğŸ“Š æœ€ç»ˆæ²»ç–—æ–¹æ¡ˆè¯„åˆ†:")
    for treatment, score in final_scores.items():
        print(f"   {treatment}: {score:.2f}")
    
    recommended_treatment = max(final_scores.items(), key=lambda x: x[1])
    print(f"\nğŸ¯ æ¨èæ²»ç–—æ–¹æ¡ˆ: {recommended_treatment[0]}")
    print(f"ğŸ’ª å…±è¯†å¼ºåº¦: {recommended_treatment[1]:.2f}")
    print(f"ğŸ”„ å¯¹è¯è½®æ•°: 3è½®")
    print(f"âœ… å…±è¯†çŠ¶æ€: å·²è¾¾æˆ")
    
    # æ­¥éª¤7: RLä¼˜åŒ–åé¦ˆ
    print("\nğŸ¤– æ­¥éª¤7: å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–åé¦ˆ")
    print("-" * 30)
    
    rl_feedback = {
        "å¥–åŠ±å€¼": 0.85,
        "åŠ¨ä½œ": "æ–°è¾…åŠ©åŒ–ç–—",
        "ç¯å¢ƒåé¦ˆ": "æ²»ç–—æ–¹æ¡ˆä¸æœ€ä½³å®è·µé«˜åº¦åŒ¹é…",
        "ä¼˜åŒ–å»ºè®®": [
            "å½“å‰æ²»ç–—æ–¹æ¡ˆè·å¾—é«˜åº¦è®¤å¯",
            "å»ºè®®å¯†åˆ‡ç›‘æµ‹æ²»ç–—ååº”",
            "å¯è€ƒè™‘ä¸ªæ€§åŒ–å‰‚é‡è°ƒæ•´"
        ]
    }
    
    print(f"ğŸ† RLå¥–åŠ±: {rl_feedback['å¥–åŠ±å€¼']:.2f}")
    print(f"ğŸ¯ æ‰§è¡ŒåŠ¨ä½œ: {rl_feedback['åŠ¨ä½œ']}")
    print(f"ğŸ“Š ç¯å¢ƒåé¦ˆ: {rl_feedback['ç¯å¢ƒåé¦ˆ']}")
    print("ğŸ’¡ ä¼˜åŒ–å»ºè®®:")
    for suggestion in rl_feedback['ä¼˜åŒ–å»ºè®®']:
        print(f"   â€¢ {suggestion}")
    
    # æ­¥éª¤8: æœ€ç»ˆæŠ¥å‘Š
    print("\nğŸ“„ æ­¥éª¤8: ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š")
    print("-" * 30)
    
    final_report = {
        "æŠ¥å‘ŠID": f"MDT_DEMO_{datetime.now().strftime('%Y%m%d_%H%M%S')}",
        "æ‚£è€…ä¿¡æ¯": patient_data,
        "æ¨èæ–¹æ¡ˆ": {
            "ä¸»è¦æ²»ç–—": recommended_treatment[0],
            "å…±è¯†å¼ºåº¦": recommended_treatment[1],
            "æ²»ç–—åºåˆ—": "æ–°è¾…åŠ©åŒ–ç–— â†’ æ‰‹æœ¯ â†’ è¾…åŠ©æ”¾ç–—"
        },
        "MDTè®¨è®º": {
            "å‚ä¸ä¸“å®¶": len(agents),
            "å¯¹è¯è½®æ•°": 3,
            "æœ€ç»ˆæ”¶æ•›åº¦": 0.92
        },
        "RLä¼˜åŒ–": rl_feedback
    }
    
    # ä¿å­˜æŠ¥å‘Š
    report_filename = f"demo_consensus_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(report_filename, 'w', encoding='utf-8') as f:
        json.dump(final_report, f, ensure_ascii=False, indent=2, default=str)
    
    print(f"ğŸ’¾ æŠ¥å‘Šå·²ä¿å­˜: {report_filename}")
    
    # æµç¨‹æ€»ç»“
    print("\n" + "=" * 60)
    print("ğŸ‰ MDTå…±è¯†è¾¾æˆæµç¨‹æ¼”ç¤ºå®Œæˆï¼")
    print("=" * 60)
    
    print("\nğŸ“‹ æµç¨‹æ€»ç»“:")
    print("1. ğŸ“Š æ‚£è€…æ•°æ®è¾“å…¥ â†’ ç»“æ„åŒ–æ‚£è€…ä¿¡æ¯")
    print("2. ğŸ” çŸ¥è¯†æ£€ç´¢ â†’ è·å–ç›¸å…³åŒ»å­¦è¯æ®")  
    print("3. ğŸ‘¥ æ™ºèƒ½ä½“åˆå§‹åŒ– â†’ 5ä¸ªä¸“ä¸šè§’è‰²å°±ä½")
    print("4. ğŸ’­ åˆå§‹æ„è§ç”Ÿæˆ â†’ å„ä¸“ä¸šç‹¬ç«‹è¯„ä¼°")
    print("5. ğŸ’¬ å¤šè½®å¯¹è¯åå•† â†’ 3è½®è®¨è®ºè¾¾æˆå…±è¯†")
    print("6. ğŸ¯ å…±è¯†è¯„ä¼° â†’ ç¡®å®šæœ€ç»ˆæ²»ç–—æ–¹æ¡ˆ")
    print("7. ğŸ¤– RLä¼˜åŒ–åé¦ˆ â†’ å¼ºåŒ–å­¦ä¹ éªŒè¯")
    print("8. ğŸ“„ æŠ¥å‘Šç”Ÿæˆ â†’ å®Œæ•´å†³ç­–è®°å½•")
    
    print(f"\nğŸ¯ æœ€ç»ˆç»“æœ:")
    print(f"   æ¨èæ²»ç–—: {recommended_treatment[0]}")
    print(f"   å…±è¯†å¼ºåº¦: {recommended_treatment[1]:.2f}")
    print(f"   RLå¥–åŠ±: {rl_feedback['å¥–åŠ±å€¼']:.2f}")
    
    return final_report

if __name__ == "__main__":
    demonstrate_consensus_flow()
    cfg = LLMConfig()
    llm = LLMInterface(cfg)
    faiss_mgr = EnhancedFAISSManager(db_path="clinical_memory_db")
    rag = MedicalKnowledgeRAG(faiss_manager=faiss_mgr)
    manager = MultiAgentDialogueManager(rag_system=rag, llm_interface=llm)